#!/bin/bash
#
# Simplified VyOS image installer script
# Based on image_installer.py --action install
# Non-interactive with default values
#

set -e

# Configuration variables
IMAGE_NAME="${IMAGE_NAME:-VyOS-1.5}"
DISK="${DISK:-/dev/sda}"
PASSWORD="${PASSWORD:-vyos}"
CONSOLE_TYPE="${CONSOLE_TYPE:-tty}"  # tty for KVM, ttyS for serial
DIR_INSTALLATION="/mnt/installation"
DIR_DST_ROOT="${DIR_INSTALLATION}/disk_dst"
DIR_KERNEL_SRC="/boot/"
FILE_ROOTFS_SRC="/usr/lib/live/mount/medium/live/filesystem.squashfs"

# Check if running in live mode
if [ ! -f "$FILE_ROOTFS_SRC" ]; then
    echo "Error: The system is already installed. Please use 'add system image' instead."
    exit 1
fi

echo "VyOS Image Installation"
echo "======================="
echo "Target disk: $DISK"
echo "Image name: $IMAGE_NAME"
echo "Console: $CONSOLE_TYPE"
echo ""

# Clean up any previous installation attempts
umount -R "$DIR_INSTALLATION" 2>/dev/null || true
rm -rf "$DIR_INSTALLATION"

# Create partition table
echo "Creating partition table on $DISK..."
# Clean up the disk
for part in "${DISK}"*[0-9]; do
    [ -e "$part" ] && wipefs -af "$part" 2>/dev/null || true
done
wipefs -af "$DISK" 2>/dev/null || true
sgdisk -Z "$DISK"

# Create partitions:
# 1: BIOS boot partition (2048-4095 sectors)
# 2: EFI system partition (4096 + 256MB)
# 3: Root partition (rest of disk)
sgdisk -a1 \
    -n1:2048:4095 -t1:EF02 \
    -n2:4096:+256M -t2:EF00 \
    -n3:0:0 -t3:8300 \
    "$DISK"

# Update kernel partition table
sync
partx -u "$DISK" || partprobe "$DISK"
sleep 2

# Determine partition names
if [[ "$DISK" == *"nvme"* ]] || [[ "$DISK" == *"mmcblk"* ]]; then
    PART_EFI="${DISK}p2"
    PART_ROOT="${DISK}p3"
else
    PART_EFI="${DISK}2"
    PART_ROOT="${DISK}3"
fi

echo "Creating filesystems..."
mkfs.fat -F 32 -n EFI "$PART_EFI"
mkfs.ext4 -L persistence "$PART_ROOT"

# Create mount points
echo "Creating mount points..."
mkdir -p "$DIR_DST_ROOT"
mkdir -p "$DIR_DST_ROOT/boot/efi"

# Mount partitions
echo "Mounting partitions..."
mount "$PART_ROOT" "$DIR_DST_ROOT"
mount "$PART_EFI" "$DIR_DST_ROOT/boot/efi"

# Create directory structure
echo "Creating directory structure..."
mkdir -p "$DIR_DST_ROOT/boot/$IMAGE_NAME/rw/opt/vyatta/etc/config"

# Set proper ownership and permissions for config directory
chown :vyattacfg "$DIR_DST_ROOT/boot/$IMAGE_NAME/rw/opt/vyatta/etc/config" 2>/dev/null || true
chmod 2775 "$DIR_DST_ROOT/boot/$IMAGE_NAME/rw/opt/vyatta/etc/config"

# Copy system image and kernel files
echo "Copying system image files..."
if [ -d "$DIR_KERNEL_SRC" ]; then
    for file in "$DIR_KERNEL_SRC"/*; do
        if [ -f "$file" ]; then
            cp "$file" "$DIR_DST_ROOT/boot/$IMAGE_NAME/"
        fi
    done
fi

if [ -f "$FILE_ROOTFS_SRC" ]; then
    cp "$FILE_ROOTFS_SRC" "$DIR_DST_ROOT/boot/$IMAGE_NAME/${IMAGE_NAME}.squashfs"
else
    echo "Error: Root filesystem not found at $FILE_ROOTFS_SRC"
    exit 1
fi

# Create default configuration
echo "Creating default configuration..."
if [ -f "/opt/vyatta/etc/config.boot.default" ]; then
    cp "/opt/vyatta/etc/config.boot.default" \
       "$DIR_DST_ROOT/boot/$IMAGE_NAME/rw/opt/vyatta/etc/config/config.boot"
else
    # Create minimal config
    cat > "$DIR_DST_ROOT/boot/$IMAGE_NAME/rw/opt/vyatta/etc/config/config.boot" <<EOF
system {
    host-name vyos
    login {
        user vyos {
            authentication {
                encrypted-password "\$6\$rounds=656000\$example\$hash"
            }
        }
    }
}
EOF
fi

# Set password (encrypt it properly)
if command -v python3 >/dev/null 2>&1; then
    ENCRYPTED_PASSWORD=$(python3 -c "import crypt; print(crypt.crypt('$PASSWORD', crypt.METHOD_SHA512))")
    # Update config with encrypted password
    sed -i "s|encrypted-password \".*\"|encrypted-password \"$ENCRYPTED_PASSWORD\"|" \
        "$DIR_DST_ROOT/boot/$IMAGE_NAME/rw/opt/vyatta/etc/config/config.boot"
fi

touch "$DIR_DST_ROOT/boot/$IMAGE_NAME/rw/opt/vyatta/etc/config/.vyatta_config"

# Create persistence.conf
echo "/ union" > "$DIR_DST_ROOT/persistence.conf"

# Set up GRUB configuration
echo "Installing GRUB configuration..."
mkdir -p "$DIR_DST_ROOT/boot/grub"
mkdir -p "$DIR_DST_ROOT/boot/grub/grub.cfg.d/vyos-versions"

# Create main grub.cfg
cat > "$DIR_DST_ROOT/boot/grub/grub.cfg" <<'GRUBEOF'
source /boot/grub/grub.cfg.d/*.cfg
source /boot/grub/grub.cfg.d/vyos-versions/*.cfg
GRUBEOF

# Create GRUB variables file
cat > "$DIR_DST_ROOT/boot/grub/grub.cfg.d/20-vyos-defaults-autoload.cfg" <<GRUBEOF
set timeout=5
set console_type=$CONSOLE_TYPE
set console_num=0
set console_speed=115200
set bootmode=normal
set default=0
GRUBEOF

# Create GRUB menu entry
BOOT_UUID=$(blkid -s UUID -o value "$PART_ROOT")
cat > "$DIR_DST_ROOT/boot/grub/grub.cfg.d/vyos-versions/${IMAGE_NAME}.cfg" <<GRUBEOF
menuentry "$IMAGE_NAME" {
    search --no-floppy --set=root --fs-uuid $BOOT_UUID
    linux /boot/$IMAGE_NAME/vmlinuz boot=live rootdelay=5 noautologin net.ifnames=0 biosdevname=0 vyos-union=/boot/$IMAGE_NAME console=\${console_type}\${console_num},\${console_speed}n8
    initrd /boot/$IMAGE_NAME/initrd.img
}
GRUBEOF

# Install GRUB bootloader
echo "Installing GRUB bootloader..."
# For BIOS mode
if [ "$(uname -m)" = "x86_64" ]; then
    grub-install --no-floppy --target=i386-pc \
        --boot-directory="$DIR_DST_ROOT/boot" "$DISK" --force
fi

# For UEFI mode
if [ "$(uname -m)" = "x86_64" ]; then
    grub-install --no-floppy --recheck --target=x86_64-efi \
        --force-extra-removable \
        --boot-directory="$DIR_DST_ROOT/boot" \
        --efi-directory="$DIR_DST_ROOT/boot/efi" \
        --bootloader-id="VyOS" \
        --uefi-secure-boot
elif [ "$(uname -m)" = "aarch64" ]; then
    grub-install --no-floppy --recheck --target=arm64-efi \
        --force-extra-removable \
        --boot-directory="$DIR_DST_ROOT/boot" \
        --efi-directory="$DIR_DST_ROOT/boot/efi" \
        --bootloader-id="VyOS" \
        --uefi-secure-boot
fi

# Sync and unmount
echo "Finalizing installation..."
sync

umount "$DIR_DST_ROOT/boot/efi"
umount "$DIR_DST_ROOT"

# Cleanup
rm -rf "$DIR_INSTALLATION"

echo ""
echo "Installation complete!"
echo "Image '$IMAGE_NAME' has been installed to $DISK"
echo "Please reboot to start VyOS"
echo ""
echo "Default login: vyos / $PASSWORD"
